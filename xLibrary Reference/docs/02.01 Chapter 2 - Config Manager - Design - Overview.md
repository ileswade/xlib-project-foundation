# Chapter 2: Config Manager - Design Overview

> **⚙️ CONFIGURATION MANAGEMENT SYSTEM**
> The Config Manager provides sophisticated TOML-based configuration with environment variable interpolation, schema validation, encryption support, and hierarchical merging for production applications.

## Quick Review

### What is the Config Manager?

The Config Manager is xlibrary's configuration pillar that eliminates the complexity of managing application settings across different environments. It provides a powerful yet intuitive interface for loading, validating, and accessing configuration from TOML files with advanced features like encryption, interpolation, and schema validation.

**Core Concept**: Professional configuration management with development-to-production continuity

```python
from xlibrary.config import ConfigManager

# Simple configuration loading
config = ConfigManager("app.toml")
api_key = config.get("api.key")
database_url = config.get("database.url")

# Advanced features work transparently
config = ConfigManager(
    sources=["base.toml", "prod.toml"],  # Hierarchical merging
    schema=validation_schema,            # Automatic validation
    encryption_key=os.getenv("CONFIG_KEY")  # Encrypted secrets
)
```

### Key Design Innovations

#### 1. **TOML-First Configuration**
Modern, readable configuration format that's better than JSON or YAML:

```toml
# app.toml
[database]
host = "localhost"
port = 5432
name = "myapp"
url = "postgresql://${database.host}:${database.port}/${database.name}"

[api]
key = "encrypted:AES256:base64encodedvalue"
timeout = 30.0
retries = 3

[features]
ai_enabled = true
debug_mode = false
```

#### 2. **Environment Variable Interpolation**
Seamlessly blend configuration files with environment variables:

```python
# Configuration automatically resolves:
# ${ENV_VAR} → Environment variables
# ${config.path} → Other config values
# ${secrets.encrypted_value} → Encrypted secrets

config = ConfigManager("app.toml")
# database.url becomes "postgresql://prod-server:5432/myapp" in production
```

#### 3. **Schema Validation System**
Type-safe configuration with descriptive validation:

```python
from xlibrary.config import Schema, required, optional, range_check

schema = Schema({
    "database": {
        "host": required(str),
        "port": required(int) | range_check(1, 65535),
        "timeout": optional(float, default=30.0)
    },
    "api": {
        "key": required(str) | pattern(r"^[a-zA-Z0-9_-]+$"),
        "retries": optional(int, default=3) | range_check(0, 10)
    }
})

config = ConfigManager("app.toml", schema=schema)
# Automatic validation on load with helpful error messages
```

#### 4. **Hierarchical Configuration Merging**
Layer configurations from multiple sources with intelligent merging:

```python
config = ConfigManager([
    "base.toml",           # Base configuration
    "environment.toml",    # Environment-specific overrides
    "local.toml"          # Local development overrides
])
# Values merge intelligently with later sources taking precedence
```

### Architecture Highlights

#### Core Components
- **ConfigManager**: Main interface for configuration access
- **Schema System**: Type validation and constraint checking
- **Interpolation Engine**: Variable resolution and substitution
- **Encryption Layer**: Secure handling of sensitive configuration
- **Loader System**: Pluggable configuration format support

#### Production Features
- **Auto-Reload**: Configuration updates without application restart
- **Environment Sections**: Different configs for dev/staging/production
- **Validation**: Comprehensive error checking with helpful messages
- **Encryption**: Built-in support for encrypted configuration values
- **Caching**: Efficient access patterns with change detection

#### Advanced Capabilities
- **Variable Interpolation**: Reference environment variables and other config values
- **Conditional Configuration**: Environment-specific configuration sections
- **Configuration Profiles**: Named configuration sets for different scenarios
- **API Key Management**: Specialized handling of API credentials
- **File Watching**: Automatic reload when configuration files change

### Design Philosophy

#### 1. **Convention Over Configuration**
Smart defaults that work immediately:

```python
# Works out of the box
config = ConfigManager()  # Looks for config.toml, app.toml, etc.

# Easy customization when needed
config = ConfigManager("custom.toml", environment="production")
```

#### 2. **Type Safety Throughout**
Configuration values are properly typed and validated:

```python
# Type-safe access with validation
port = config.get("database.port", type=int)  # Guaranteed integer
timeout = config.get("api.timeout", type=float, default=30.0)
```

#### 3. **Security by Default**
Sensitive values are handled securely:

```python
# Automatic encryption detection and decryption
api_key = config.get("api.secret_key")  # Automatically decrypted
# Original: "encrypted:AES256:base64value"
# Returned: "actual-secret-key"
```

#### 4. **Environment-Aware**
Seamless development to production configuration:

```toml
# Development values
[database]
host = "localhost"
debug = true

# Production overrides
[production.database]
host = "${DB_HOST}"  # From environment
debug = false
```

### Performance Characteristics

- **Lazy Loading**: Configuration loaded only when accessed
- **Caching**: Parsed values cached for fast repeated access
- **Change Detection**: Efficient file monitoring for auto-reload
- **Memory Efficient**: Minimal memory footprint even with large configs
- **Fast Parsing**: Optimized TOML parsing and validation

### Integration Points

The Config Manager integrates seamlessly with other xlibrary pillars:

- **AI Manager**: Load AI provider settings and API keys
- **Download Manager**: Configure download paths and strategies
- **Encryption Manager**: Automatic encryption/decryption of sensitive values
- **Database Connections**: Type-safe database configuration
- **Logging Systems**: Centralized logging configuration

### Error Handling Strategy

Descriptive error messages with specific solutions:

```python
try:
    config = ConfigManager("app.toml")
    db_port = config.get("database.port")
except ValidationError as e:
    # Clear message: "database.port must be an integer between 1 and 65535, got 'localhost'"
    print(f"Configuration error: {e.message}")
    print(f"Solution: {e.suggestion}")
except FileNotFoundError as e:
    print(f"Missing configuration file: {e.filename}")
    print(f"Expected locations: {e.search_paths}")
```

### Configuration Examples

#### Simple Application Config
```toml
# app.toml
app_name = "My Application"
version = "1.0.0"
debug = false

[database]
host = "localhost"
port = 5432
name = "myapp"

[logging]
level = "INFO"
file = "app.log"
```

#### Production Configuration
```toml
# prod.toml
debug = false

[database]
host = "${DB_HOST}"
port = "${DB_PORT:5432}"  # Default if not set
password = "encrypted:AES256:encrypted_password_here"

[api]
claude_key = "encrypted:AES256:encrypted_claude_key"
openai_key = "encrypted:AES256:encrypted_openai_key"
```

#### Development Overrides
```toml
# local.toml
debug = true

[database]
host = "localhost"
name = "myapp_dev"

[logging]
level = "DEBUG"
```

---

## Next Steps

- **[Detailed Design Discussion](02.02%20Chapter%202%20-%20Config%20Manager%20-%20Design%20-%20Detailed.md)** - Deep dive into architecture, validation systems, and encryption
- **[User Guide Overview](02.03%20Chapter%202%20-%20Config%20Manager%20-%20User%20Guide%20-%20Overview.md)** - Quick start guide for practical configuration management
- **[User Guide Detailed](02.04%20Chapter%202%20-%20Config%20Manager%20-%20User%20Guide%20-%20Detailed.md)** - Comprehensive feature coverage and advanced patterns

**The Config Manager represents xlibrary's commitment to making application configuration professional, secure, and maintainable.** ⚙️