# Chapter 2: Config Manager - User Guide Overview

> **üöÄ QUICK START GUIDE**
> Get up and running with the Config Manager in 5 minutes. Essential patterns for TOML configuration, environment variables, and schema validation.

## 5-Minute Quick Start

### Installation
```bash
# Install config pillar
pip install xlibrary[config]
```

### Basic Usage

Create a configuration file:
```toml
# app.toml
app_name = "My Application"
version = "1.0.0"
debug = false

[database]
host = "localhost"
port = 5432
name = "myapp"
timeout = 30.0

[api]
base_url = "https://api.example.com"
timeout = 15.0
retries = 3
```

Load and use configuration:
```python
from xlibrary.config import ConfigManager

# Load configuration
config = ConfigManager("app.toml")

# Access values with dot notation
app_name = config.get("app_name")
db_host = config.get("database.host")
api_timeout = config.get("api.timeout")

print(f"App: {app_name}")
print(f"Database: {db_host}:{config.get('database.port')}")
print(f"API timeout: {api_timeout}s")
```

---

## Essential Patterns

### 1. Environment Variables

Mix configuration files with environment variables:

```toml
# config.toml
[database]
host = "${DB_HOST:localhost}"  # Use DB_HOST env var, default to localhost
port = "${DB_PORT:5432}"       # Use DB_PORT env var, default to 5432
password = "${DB_PASSWORD}"    # Required from environment
```

```python
import os
os.environ['DB_HOST'] = 'prod-server'
os.environ['DB_PASSWORD'] = 'secret123'

config = ConfigManager("config.toml")
print(config.get("database.host"))      # "prod-server"
print(config.get("database.password"))  # "secret123"
```

### 2. Type-Safe Access

Ensure configuration values have the correct types:

```python
config = ConfigManager("app.toml")

# Type-safe access with validation
port = config.get("database.port", type=int)           # Guaranteed integer
timeout = config.get("api.timeout", type=float)        # Guaranteed float
debug = config.get("debug", type=bool, default=False)  # Guaranteed boolean

# Will raise TypeError if types don't match
```

### 3. Hierarchical Configuration

Layer configurations for different environments:

```python
config = ConfigManager([
    "base.toml",        # Base configuration
    "prod.toml",        # Production overrides
    "local.toml"        # Local development overrides (if exists)
])

# Later files override earlier ones
db_host = config.get("database.host")  # From the last file that defined it
```

### 4. Schema Validation

Validate configuration structure and values:

```python
from xlibrary.config import ConfigManager, Schema, required, optional, range_check

# Define schema
schema = Schema({
    "database": {
        "host": required(str),
        "port": required(int) | range_check(1, 65535),
        "timeout": optional(float, default=30.0)
    },
    "api": {
        "timeout": required(float) | range_check(0.1, 60.0),
        "retries": optional(int, default=3) | range_check(0, 10)
    }
})

# Load with validation
config = ConfigManager("app.toml", schema=schema)
# Automatically validated on load with helpful error messages
```

### 5. Encrypted Configuration

Store sensitive values securely:

```toml
# config.toml
[api]
public_key = "pk_1234567890"
secret_key = "encrypted:FERNET:gAAAAABhZ2I..."  # Encrypted value

[database]
username = "myapp"
password = "encrypted:FERNET:gAAAAABhZ2I..."   # Encrypted password
```

```python
import os
os.environ['CONFIG_ENCRYPTION_KEY'] = 'your-32-byte-key-here'

config = ConfigManager("config.toml", encryption_key=os.getenv('CONFIG_ENCRYPTION_KEY'))

# Automatically decrypted when accessed
secret = config.get("api.secret_key")  # Returns decrypted value
password = config.get("database.password")  # Returns decrypted password
```

---

## Common Use Cases

### 1. Database Configuration

```toml
# database.toml
[database]
host = "${DB_HOST:localhost}"
port = "${DB_PORT:5432}"
name = "${DB_NAME:myapp}"
username = "${DB_USER:postgres}"
password = "${DB_PASSWORD}"
pool_size = 10
timeout = 30.0
ssl_mode = "require"
```

```python
from xlibrary.config import ConfigManager

def create_database_connection():
    config = ConfigManager("database.toml")

    connection_params = {
        'host': config.get("database.host"),
        'port': config.get("database.port", type=int),
        'database': config.get("database.name"),
        'user': config.get("database.username"),
        'password': config.get("database.password"),
        'pool_size': config.get("database.pool_size", type=int),
        'connect_timeout': config.get("database.timeout", type=float)
    }

    return connection_params

# Usage
db_params = create_database_connection()
print(f"Connecting to {db_params['host']}:{db_params['port']}")
```

### 2. Multi-Environment Setup

```toml
# base.toml
app_name = "My Application"
version = "1.0.0"

[database]
timeout = 30.0
pool_size = 5

[logging]
format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# development.toml
debug = true
[database]
host = "localhost"
name = "myapp_dev"
[logging]
level = "DEBUG"

# production.toml
debug = false
[database]
host = "${DATABASE_HOST}"
name = "${DATABASE_NAME}"
[logging]
level = "INFO"
file = "/var/log/myapp.log"
```

```python
import os
from xlibrary.config import ConfigManager

def load_environment_config():
    env = os.getenv("ENVIRONMENT", "development")

    config_files = [
        "base.toml",
        f"{env}.toml"
    ]

    config = ConfigManager(config_files)

    return config, env

# Usage
config, environment = load_environment_config()
print(f"Running in {environment} mode")
print(f"Debug enabled: {config.get('debug', type=bool)}")
print(f"Database: {config.get('database.host')}")
```

### 3. API Configuration Manager

```toml
# api.toml
[endpoints]
primary = "https://api.example.com/v1"
fallback = "https://backup-api.example.com/v1"

[authentication]
api_key = "${API_KEY}"
secret = "encrypted:FERNET:gAAAAABhZ2I..."

[rate_limits]
requests_per_minute = 1000
burst_limit = 100

[timeouts]
connect = 5.0
read = 30.0
total = 60.0
```

```python
from xlibrary.config import ConfigManager

class APIConfig:
    def __init__(self, config_file="api.toml"):
        self.config = ConfigManager(config_file)

    @property
    def primary_endpoint(self):
        return self.config.get("endpoints.primary")

    @property
    def api_key(self):
        return self.config.get("authentication.api_key")

    @property
    def timeout_config(self):
        return {
            'connect': self.config.get("timeouts.connect", type=float),
            'read': self.config.get("timeouts.read", type=float),
            'total': self.config.get("timeouts.total", type=float)
        }

    @property
    def rate_limits(self):
        return {
            'rpm': self.config.get("rate_limits.requests_per_minute", type=int),
            'burst': self.config.get("rate_limits.burst_limit", type=int)
        }

# Usage
api_config = APIConfig()
print(f"Endpoint: {api_config.primary_endpoint}")
print(f"Rate limit: {api_config.rate_limits['rpm']} RPM")
```

### 4. Auto-Reloading Configuration

```python
from xlibrary.config import ConfigManager

def create_auto_reloading_config():
    config = ConfigManager(
        "app.toml",
        auto_reload=True  # Automatically reload when file changes
    )

    def on_config_change(changed_files):
        print(f"Configuration reloaded from: {changed_files}")
        # Reinitialize components that depend on config

    config.add_change_callback(on_config_change)

    return config

# Usage - configuration updates automatically when file changes
config = create_auto_reloading_config()

# This value will update automatically when app.toml changes
while True:
    debug_mode = config.get("debug", type=bool)
    print(f"Debug mode: {debug_mode}")
    time.sleep(5)
```

### 5. Configuration Validation Example

```python
from xlibrary.config import ConfigManager, Schema, required, optional, range_check, pattern

def create_validated_config():
    # Define comprehensive schema
    schema = Schema({
        "app": {
            "name": required(str) | pattern(r"^[a-zA-Z0-9_-]+$"),
            "version": required(str) | pattern(r"^\d+\.\d+\.\d+$"),
            "debug": optional(bool, default=False)
        },
        "database": {
            "host": required(str),
            "port": required(int) | range_check(1, 65535),
            "timeout": optional(float, default=30.0) | range_check(0.1, 300.0),
            "pool_size": optional(int, default=5) | range_check(1, 100)
        },
        "api": {
            "base_url": required(str) | pattern(r"^https?://"),
            "timeout": optional(float, default=30.0) | range_check(1.0, 120.0),
            "retries": optional(int, default=3) | range_check(0, 10)
        }
    })

    try:
        config = ConfigManager("app.toml", schema=schema)
        print("‚úÖ Configuration validation passed")
        return config

    except ValidationError as e:
        print(f"‚ùå Configuration validation failed:")
        for error in e.errors:
            print(f"  - {error.path}: {error.message}")
            if error.suggestion:
                print(f"    Suggestion: {error.suggestion}")
        return None

# Usage
config = create_validated_config()
if config:
    print(f"App: {config.get('app.name')} v{config.get('app.version')}")
```

---

## Error Handling Patterns

### Basic Error Handling

```python
from xlibrary.config import ConfigManager, ConfigError, ValidationError

try:
    config = ConfigManager("app.toml")
    db_host = config.get("database.host")

except FileNotFoundError as e:
    print(f"Configuration file not found: {e.filename}")
    print(f"Searched in: {e.search_paths}")

except ValidationError as e:
    print("Configuration validation failed:")
    for error in e.errors:
        print(f"  {error.path}: {error.message}")

except ConfigError as e:
    print(f"Configuration error: {e}")
```

### Graceful Fallbacks

```python
def load_config_with_fallbacks():
    """Load configuration with multiple fallback strategies"""

    # Try primary configuration
    try:
        return ConfigManager("app.toml")
    except FileNotFoundError:
        pass

    # Try alternative locations
    fallback_paths = [
        "config/app.toml",
        "settings.toml",
        "default.toml"
    ]

    for path in fallback_paths:
        try:
            print(f"Trying fallback config: {path}")
            return ConfigManager(path)
        except FileNotFoundError:
            continue

    # Use minimal default configuration
    print("Using default configuration")
    return ConfigManager()  # Empty config with defaults

# Usage
config = load_config_with_fallbacks()
```

---

## Best Practices

### 1. **Environment Variable Patterns**
```bash
# Use consistent naming
export APP_DATABASE_HOST="prod-server"
export APP_DATABASE_PASSWORD="secret123"
export APP_API_KEY="your-api-key"

# Use encryption key for sensitive configs
export APP_CONFIG_ENCRYPTION_KEY="your-32-byte-encryption-key"
```

### 2. **Configuration Structure**
```toml
# Group related settings
[database]
host = "localhost"
port = 5432
# ... other database settings

[api]
base_url = "https://api.example.com"
timeout = 30.0
# ... other API settings

[logging]
level = "INFO"
file = "app.log"
# ... other logging settings
```

### 3. **Type Safety**
```python
# Always specify types for critical values
port = config.get("database.port", type=int)
timeout = config.get("api.timeout", type=float, default=30.0)
debug = config.get("debug", type=bool, default=False)
```

### 4. **Schema Validation**
```python
# Use schemas for production applications
schema = Schema({
    # Define all expected configuration
})

config = ConfigManager("app.toml", schema=schema)
```

---

## Next Steps

Ready for advanced configuration management?

- **[Detailed User Guide](02.04%20Chapter%202%20-%20Config%20Manager%20-%20User%20Guide%20-%20Detailed.md)** - Comprehensive feature coverage
- **[Chapter 3: Download Manager](03.01%20Chapter%203%20-%20Download%20Manager%20-%20Design%20-%20Overview.md)** - Advanced download capabilities
- **[Design Documentation](02.01%20Chapter%202%20-%20Config%20Manager%20-%20Design%20-%20Overview.md)** - Architectural details

**You're now ready to build applications with professional configuration management!** üéâ

---

## Troubleshooting

### Common Issues

**"File not found" error:**
```python
# Check if file exists
config_file = Path("app.toml")
if not config_file.exists():
    print(f"Create configuration file at: {config_file.absolute()}")

# Or use fallback
config = ConfigManager("app.toml" if config_file.exists() else None)
```

**Environment variable not resolving:**
```bash
# Check environment variable is set
echo $DB_HOST

# Use defaults in configuration
# database.host = "${DB_HOST:localhost}"
```

**Validation errors:**
```python
try:
    config = ConfigManager("app.toml", schema=schema)
except ValidationError as e:
    print("Fix these configuration errors:")
    for error in e.errors:
        print(f"- {error.path}: {error.message}")
```